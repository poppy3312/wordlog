<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WordLog ä¿®å¤è„šæœ¬æ‰§è¡Œå™¨</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ WordLog ä¿®å¤è„šæœ¬</h1>
    <p class="subtitle">ä¿®å¤ç°æœ‰å•è¯çš„ä¸­æ–‡é‡Šä¹‰</p>

    <button id="runBtn" onclick="runFix()">ğŸš€ è¿è¡Œä¿®å¤è„šæœ¬</button>

    <div id="output"></div>
  </div>

  <script>
    const output = document.getElementById('output');
    const runBtn = document.getElementById('runBtn');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = message;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    async function runFix() {
      runBtn.disabled = true;
      output.innerHTML = '';
      log('ğŸ”§ å¼€å§‹ä¿®å¤ç°æœ‰å•è¯çš„é‡Šä¹‰...', 'info');

      try {
        // ä¼˜å…ˆä» localStorage è¯»å–ï¼ˆç½‘é¡µç‰ˆï¼‰
        let words = [];
        const localWords = localStorage.getItem('wordlog_words');

        if (localWords) {
          try {
            words = JSON.parse(localWords);
            log('âœ… ä» localStorage è¯»å–åˆ°å•è¯æ•°æ®', 'success');
          } catch (e) {
            log('âŒ localStorage æ•°æ®è§£æå¤±è´¥', 'error');
          }
        }

        // å¦‚æœ localStorage æ²¡æœ‰ï¼Œå°è¯•ä» chrome.storage è¯»å–ï¼ˆæ‰©å±•ç¯å¢ƒï¼‰
        if (words.length === 0 && typeof chrome !== 'undefined' && chrome.storage) {
          const result = await chrome.storage.local.get(['words']);
          words = result.words || [];
          if (words.length > 0) {
            log('âœ… ä» chrome.storage è¯»å–åˆ°å•è¯æ•°æ®', 'success');
          }
        }

        if (words.length === 0) {
          log('âŒ æ²¡æœ‰æ‰¾åˆ°å•è¯æ•°æ®', 'error');
          log('è¯·å…ˆåœ¨ WordLog ä¸­æ·»åŠ ä¸€äº›å•è¯', 'info');
          runBtn.disabled = false;
          return;
        }

        log(`ğŸ“š æ‰¾åˆ° ${words.length} ä¸ªå•è¯`, 'info');

        // 4ä¸ªå•è¯çš„æ­£ç¡®ä¸­æ–‡é‡Šä¹‰ï¼ˆå«éŸ³æ ‡ï¼‰
        const correctDefinitions = {
          'extension': {
            pronunciation: '/ÉªkËˆstenÊƒn/',
            partOfSpeech: 'åè¯',
            definition: 'æ‰©å±•ï¼›å»¶é•¿ï¼›ç”µè¯åˆ†æœº',
            example: 'I installed a new browser extension.',
            exampleTranslation: 'æˆ‘å®‰è£…äº†ä¸€ä¸ªæ–°çš„æµè§ˆå™¨æ‰©å±•ã€‚'
          },
          'proceed': {
            pronunciation: '/prÉ™ËˆsiËd/',
            partOfSpeech: 'åŠ¨è¯',
            definition: 'ç»§ç»­è¿›è¡Œï¼›å‰è¿›',
            example: 'Please proceed with your presentation.',
            exampleTranslation: 'è¯·ç»§ç»­ä½ çš„æ¼”ç¤ºã€‚'
          },
          'beaming': {
            pronunciation: '/ËˆbiËmÉªÅ‹/',
            partOfSpeech: 'å½¢å®¹è¯',
            definition: 'å¾®ç¬‘çš„ï¼›å‘å…‰çš„ï¼›å®¹å…‰ç„•å‘',
            example: 'She was beaming with happiness.',
            exampleTranslation: 'å¥¹å¼€å¿ƒåœ°å¾®ç¬‘ç€ã€‚'
          },
          'method': {
            pronunciation: '/ËˆmeÎ¸É™d/',
            partOfSpeech: 'åè¯',
            definition: 'æ–¹æ³•ï¼›æ–¹å¼',
            example: 'This is a good method to learn English.',
            exampleTranslation: 'è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ è‹±è¯­çš„å¥½æ–¹æ³•ã€‚'
          }
        };

        let updatedCount = 0;
        let skippedCount = 0;

        // æ›´æ–°å•è¯é‡Šä¹‰
        for (const word of words) {
          const wordLower = word.word.toLowerCase();
          const correctDef = correctDefinitions[wordLower];

          if (correctDef) {
            // æ£€æŸ¥å½“å‰é‡Šä¹‰æ˜¯å¦æ˜¯å ä½ç¬¦
            const currentDef = word.definitions && word.definitions[0];
            const needsUpdate = !currentDef ||
              currentDef.definition === 'æµ‹è¯•é‡Šä¹‰' ||
              currentDef.definition === 'é‡Šä¹‰æš‚ä¸å¯ç”¨ï¼Œå¯ç¨åæ‰‹åŠ¨è¡¥å……' ||
              currentDef.example === 'Test example';

            if (needsUpdate) {
              // æ›´æ–°ä¸ºæ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰å’ŒéŸ³æ ‡
              word.definitions = [{
                partOfSpeech: correctDef.partOfSpeech,
                definition: correctDef.definition,
                example: correctDef.example,
                exampleTranslation: correctDef.exampleTranslation
              }];

              // æ›´æ–°éŸ³æ ‡ï¼ˆä½¿ç”¨æ­£ç¡®çš„éŸ³æ ‡ï¼‰
              word.pronunciation = correctDef.pronunciation;

              updatedCount++;
              log(`âœ… å·²æ›´æ–°: ${word.word} ${correctDef.pronunciation}`, 'success');
            } else {
              skippedCount++;
              log(`â„¹ï¸ ${word.word} å·²æ˜¯æ­£ç¡®é‡Šä¹‰ï¼Œè·³è¿‡`, 'info');
            }
          }
        }

        // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        if (updatedCount > 0) {
          // ä¿å­˜åˆ° localStorage
          localStorage.setItem('wordlog_words', JSON.stringify(words));

          // åŒæ—¶ä¿å­˜åˆ° chrome.storageï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if (typeof chrome !== 'undefined' && chrome.storage) {
            await chrome.storage.local.set({ words: words });
          }

          log(``, 'info');
          log(`ğŸ‰ æˆåŠŸæ›´æ–°äº† ${updatedCount} ä¸ªå•è¯çš„é‡Šä¹‰ï¼`, 'success');
          log(`ğŸ“ è¯·åˆ·æ–° WordLog ç½‘é¡µ (http://localhost:3001) æŸ¥çœ‹æ•ˆæœ`, 'info');

          if (skippedCount > 0) {
            log(`â„¹ï¸ è·³è¿‡äº† ${skippedCount} ä¸ªå·²æ˜¯æ­£ç¡®é‡Šä¹‰çš„å•è¯`, 'info');
          }
        } else {
          log('â„¹ï¸ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å•è¯ï¼Œæˆ–æ‰€æœ‰å•è¯éƒ½å·²ç»æ˜¯æ­£ç¡®é‡Šä¹‰', 'info');
        }

        // æ˜¾ç¤ºå½“å‰å•è¯åˆ—è¡¨
        log(``, 'info');
        log('ğŸ“‹ å½“å‰å•è¯åˆ—è¡¨:', 'info');
        words.forEach((w, i) => {
          const def = w.definitions && w.definitions[0];
          log(`${i + 1}. ${w.word}`, 'info');
          log(`   è¯æ€§: ${def ? def.partOfSpeech : 'æ— '}`, 'info');
          log(`   é‡Šä¹‰: ${def ? def.definition : 'æ— '}`, 'info');
          log(`   ä¾‹å¥: ${def ? def.example : 'æ— '}`, 'info');
          log(`   è¯‘æ–‡: ${def && def.exampleTranslation ? def.exampleTranslation : 'æ— '}`, 'info');
        });

      } catch (error) {
        log(`âŒ æ‰§è¡Œå‡ºé”™: ${error.message}`, 'error');
        console.error(error);
      }

      runBtn.disabled = false;
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
    log('âœ… ä¿®å¤è„šæœ¬å·²å°±ç»ª', 'success');
    log('ğŸ‘† ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹ä¿®å¤', 'info');
  </script>
</body>
</html>
