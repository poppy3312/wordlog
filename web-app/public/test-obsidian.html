<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obsidian API æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #D97757; margin-bottom: 20px; }
        .section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.connected { background: #e8f5e9; color: #2e7d32; }
        .status.disconnected { background: #ffebee; color: #c62828; }
        .status.checking { background: #e3f2fd; color: #1565c0; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        button {
            background: #D97757;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #c06649; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .result.success { background: #e8f5e9; color: #2e7d32; }
        .result.error { background: #ffebee; color: #c62828; }
        .result.info { background: #e3f2fd; color: #1565c0; }
        .config {
            background: #fff3e0;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .config-item {
            margin: 10px 0;
        }
        .config-item label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ Obsidian API æµ‹è¯•å·¥å…·</h1>

        <!-- API çŠ¶æ€æ£€æµ‹ -->
        <div class="section">
            <h3>API è¿æ¥çŠ¶æ€</h3>
            <p style="margin: 10px 0;">
                çŠ¶æ€: <span id="apiStatus" class="status checking">æ£€æµ‹ä¸­...</span>
            </p>
            <button onclick="checkAPI()">é‡æ–°æ£€æµ‹</button>
        </div>

        <!-- API é…ç½® -->
        <div class="section">
            <h3>API é…ç½®</h3>
            <div class="config">
                <div class="config-item">
                    <label>API ç«¯ç‚¹</label>
                    <input type="text" id="apiEndpoint" value="http://localhost:27124">
                </div>
                <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- æµ‹è¯•å•è¯åŒæ­¥ -->
        <div class="section">
            <h3>æµ‹è¯•å•è¯åŒæ­¥</h3>
            <div class="config-item">
                <label>æµ‹è¯•å•è¯</label>
                <input type="text" id="testWord" value="example" placeholder="è¾“å…¥æµ‹è¯•å•è¯">
            </div>
            <button onclick="testSync()">æµ‹è¯•åŒæ­¥</button>
            <button onclick="testCreateNote()">æµ‹è¯•åˆ›å»ºç¬”è®°</button>
            <button onclick="testListNotes()">æµ‹è¯•åˆ—å‡ºç¬”è®°</button>
        </div>

        <!-- ç»“æœè¾“å‡º -->
        <div id="output"></div>
    </div>

    <script>
        const DEFAULT_API_ENDPOINT = 'http://localhost:27124';

        // åŠ è½½é…ç½®
        function loadConfig() {
            const config = localStorage.getItem('obsidian_api_config');
            if (config) {
                const { apiEndpoint } = JSON.parse(config);
                document.getElementById('apiEndpoint').value = apiEndpoint;
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const apiEndpoint = document.getElementById('apiEndpoint').value;
            localStorage.setItem('obsidian_api_config', JSON.stringify({ apiEndpoint }));
            showOutput('success', 'âœ… é…ç½®å·²ä¿å­˜');
            checkAPI();
        }

        // è·å– API ç«¯ç‚¹
        function getApiEndpoint() {
            return document.getElementById('apiEndpoint').value || DEFAULT_API_ENDPOINT;
        }

        // æ£€æµ‹ API è¿æ¥
        async function checkAPI() {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = 'status checking';
            statusEl.textContent = 'æ£€æµ‹ä¸­...';

            try {
                const response = await fetch(`${getApiEndpoint()}/`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    statusEl.className = 'status connected';
                    statusEl.textContent = 'âœ“ å·²è¿æ¥';
                    showOutput('success', 'âœ… Obsidian API è¿æ¥æˆåŠŸï¼');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusEl.className = 'status disconnected';
                statusEl.textContent = 'âœ— æœªè¿æ¥';
                showOutput('error', `âŒ è¿æ¥å¤±è´¥: ${error.message}\n\nè¯·ç¡®ä¿ï¼š\n1. Obsidian æ­£åœ¨è¿è¡Œ\n2. Local REST API æ’ä»¶å·²å¯ç”¨\n3. API ç«¯å£æ­£ç¡®`);
            }
        }

        // ç”Ÿæˆç¬”è®°å†…å®¹
        function generateNoteContent(word) {
            return `---
tags: [wordlog/è‹±è¯­, å•è¯æœ¬/æµ‹è¯•]
cssclass: flashcard
created: ${new Date().toISOString()}
source: test
---

# ${word}

## éŸ³æ ‡
/${word}/

## è¯æ€§
åè¯

## é‡Šä¹‰
æµ‹è¯•é‡Šä¹‰

## ä¾‹å¥
> This is a test example for "${word}".
>
> è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä¾‹å¥ã€‚

---
<!--SR:!2026-02-05,1,270-->
`;
        }

        // æµ‹è¯•åˆ›å»ºç¬”è®°
        async function testCreateNote() {
            const word = document.getElementById('testWord').value || 'test';
            showOutput('info', `ğŸ”„ æ­£åœ¨åˆ›å»ºç¬”è®°: ${word}...`);

            try {
                const content = generateNoteContent(word);
                const notePath = `WordLog/${word}.md`;

                const response = await fetch(`${getApiEndpoint()}/vault/${encodeURIComponent(notePath)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'text/markdown',
                        'Accept': 'application/json'
                    },
                    body: content
                });

                if (response.ok) {
                    showOutput('success', `âœ… ç¬”è®°åˆ›å»ºæˆåŠŸï¼\n\nè·¯å¾„: WordLog/${word}.md\n\nå†…å®¹é¢„è§ˆ:\n${content}`);
                } else {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
            } catch (error) {
                showOutput('error', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•åˆ—å‡ºç¬”è®°
        async function testListNotes() {
            showOutput('info', 'ğŸ”„ æ­£åœ¨åˆ—å‡ºç¬”è®°...');

            try {
                const response = await fetch(`${getApiEndpoint()}/vault/`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    showOutput('success', `âœ… è·å–æˆåŠŸï¼\n\nç¬”è®°åˆ—è¡¨:\n${JSON.stringify(data, null, 2)}`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showOutput('error', `âŒ åˆ—å‡ºå¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•å®Œæ•´åŒæ­¥æµç¨‹
        async function testSync() {
            const word = document.getElementById('testWord').value || 'test';
            showOutput('info', `ğŸ”„ æ­£åœ¨æµ‹è¯•åŒæ­¥: ${word}...`);

            try {
                // 1. æ£€æŸ¥ API
                const checkResponse = await fetch(`${getApiEndpoint()}/`);
                if (!checkResponse.ok) {
                    throw new Error('API ä¸å¯ç”¨');
                }

                // 2. åˆ›å»ºç¬”è®°
                const content = generateNoteContent(word);
                const notePath = `WordLog/${word}.md`;

                const createResponse = await fetch(`${getApiEndpoint()}/vault/${encodeURIComponent(notePath)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'text/markdown',
                        'Accept': 'application/json'
                    },
                    body: content
                });

                if (createResponse.ok) {
                    showOutput('success', `âœ… åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\nå•è¯: ${word}\nè·¯å¾„: WordLog/${word}.md\n\nè¯·åœ¨ Obsidian ä¸­æŸ¥çœ‹è¯¥ç¬”è®°`);
                } else {
                    throw new Error(`åˆ›å»ºç¬”è®°å¤±è´¥: HTTP ${createResponse.status}`);
                }
            } catch (error) {
                showOutput('error', `âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºè¾“å‡º
        function showOutput(type, message) {
            const output = document.getElementById('output');
            output.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            loadConfig();
            checkAPI();
        };
    </script>
</body>
</html>
